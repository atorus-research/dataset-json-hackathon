---
title: "xportrjson"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{xportrjson}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Objectives

1. Read in a dataset-JSON DM file
2. Add a new variable to the dataset
3. Update metadata within JSON file
4. Write out the dataset-JSON file


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(DT)
```

## Read in a dataset-JSON DM file

Below we use the `read_dataset_json` to read into our R session a Demographics dataset-JSON file via a url. 


```{r setup, message = FALSE}
library(dplyr)
library(jsonlite)
library(xportr)
library(xportrjson)

dm <- read_dataset_json(url("https://raw.githubusercontent.com/lexjansen/sas-papers/master/pharmasug-2022/json/sdtm/dm.json"))
```

```{r, echo=FALSE}
glimpse(dm)
```

The `read_dataset_json` also reads in the metadata from the JSON file and applies it to the dataframe.  For example, the variable `RFXSTDTC` has the label `Date/Time of First Study Treatment` applied to it.
 
```{r}
attributes(dm$RFXSTDTC)
```

To get a better idea of what is in the JSON metadata file for the DM data, lets take a quick look.

```{r}
raw_dm <- jsonlite::fromJSON(url("https://raw.githubusercontent.com/lexjansen/sas-papers/master/pharmasug-2022/json/sdtm/dm.json"), simplifyVector = TRUE)

head(raw_dm$clinicalData$itemGroupData[[1]]$items, 5)
```

```{r}
meta <- raw_dm$clinicalData$itemGroupData[[1]]$items

  # Pull out the actual data, and convert the character matrix to a dataframe
dat <- raw_dm$clinicalData$itemGroupData[[1]]$itemData %>%
    as_tibble(.name_repair="minimal")

  # Apply the variable names onto the dataframe
  names(dat) <- meta$name

  # Loop over each variable in the dataframe
  for (i in seq_along(dat)) {
    # Apply a variable label
    label(dat[[i]]) <- meta$label[i]

    # Covert the type if it's not a string
    if (meta$type[i] != "string") {
      dat[i] <- type_converter(meta$type[i])(dat[[i]])
    }
  }

dat
```
## Add a new variable to the dataset

We can read in JSON-based dataset, but now we would like to add a new variable and update the metadata associated with this variable.  First, let's add the variable 

```{r}
spec <- data.frame(
  name = c("TRT01P", "TRT01A"),
  OID = c("IT.ADSL.TRT01P", "IT.ADSL.TRT01A"),
  length = c(28, 28),
  type = c("string", "string"),
  label = c("Planned Treatment for Period 01", "Actual Treatment for Period 01")
) %>% 
  bind_rows(meta) %>% 
  rename(variable=name)
  

adsl <- dm %>%
  mutate(TRT01P = ARM, TRT01A = ACTARM) %>% 
  xportr_length(spec) %>% 
  xportr_label(spec)

adsl
```

```{r}
toJSON(adsl)
```
